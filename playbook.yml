---
- name: Configure Server
  hosts: aws_instances
  become: yes
  roles:
    - config
    - docker

  tasks:

    - name: Install required packages
      apt:
        name:
          - golang-go
        state: present

    - name: Install AWS CLI
      pip:
        name: awscli
        executable: pip3

    - name: Set up pplanel user with sudo privileges
      user:
        name: pplanel
        shell: /bin/bash
        groups: sudo
        append: yes
        create_home: yes

    - name: Copy authorized_keys for pplanel
      ansible.builtin.copy:
        remote_src: /home/ubuntu/.ssh/authorized_keys
        dest: /home/pplanel/.ssh/authorized_keys
        owner: pplanel
        group: pplanel
        mode: '0644'

    - name: Update sshd_config to disallow root login and password authentication
      lineinfile:
        path: /etc/ssh/sshd_config
        line: |
          PermitRootLogin no
          PasswordAuthentication no
        backup: yes
      notify: Restart SSH

  handlers:
    - name: Restart SSH
      service:
        name: ssh
        state: restarted

